#!groovy

pipeline {
    agent any
    environment {
        GIT_STATE = "${env.GIT_BRANCH == 'master' && env.CHANGE_ID == null ? 'deploy' : 'else'}"
    }
    tools {
        jdk 'openjdk-11'
    }
    stages{
        stage('Git Checkout'){
            steps{
                script{
                    env.GIT_COMMIT = checkout scm
                    sh "echo ${env.GIT_STATE} GIT_COMMIT : ${env.GIT_COMMIT}"
                }
            }
        }
        stage('Gradlew Build'){
            options{
                retry(1)
            }
            steps{
                script{
                    sh """
                    chmod +x ./gradlew
                    ./gradlew build
                    """
                }
            }
            post{
                failure{
                    sh "./gradle --stop"
                }
            }
        }
        stage('Test'){
            options{
                retry(1)
            }
            steps{
                script{
                    sh "./gradlew test"
                    sh "./gradlew check"
                    sh "echo 'generating coverage report'"
                    sh "./gradlew codeCoverageReport"
                    sh "echo 'send it to codecov'"
                    sh "curl -s https://codecov.io/bash | bash"
                }
            }
            post{
                failure{
                    sh "./gradle --stop"
                }
            }
        }
        stage('JIB Docker images'){
            when{
                expression{ env.GIT_STATE == 'deploy' }
            }
            options{
                retry(1)
            }
            steps{
                script{
                    docker.withRegistry(HARBOR_REPOSITORY, HARBOR_CREDENTIAL){
                        sh """
                        ./gradlew jibDockerBuild
                        """
                    }

                }
            }
            post{
                failure{
                    sh "./gradle --stop"
                }
            }
        }
        stage('Push image to Harbor'){
            when{
                expression{ env.GIT_STATE == 'deploy' }
            }
            steps{
                script{
                    docker.withRegistry(HARBOR_REPOSITORY, HARBOR_CREDENTIAL){
                        docker.image('gaonna_platform/admin:latest').push("${env.GIT_COMMIT}")
                        docker.image('gaonna_platform/api:latest').push("${env.GIT_COMMIT}")
                    }
                }
            }
        }
    }
}
