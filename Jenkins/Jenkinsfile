#!groovy

pipeline {
    agent any
    tools {
        jdk 'openjdk-11'
    }
    stages{
        stage('Git Checkout'){
            steps{
                script{
                    env.GIT_COMMIT = checkout scm
                    sh "echo ${env.GIT_COMMIT}"
                }
            }
        }
        stage('Get Status'){
            steps{
                when{
                    allOf {
                        ${env.CHANGE_ID} == null
                        branch 'master'
                    }
                }
                sh "echo deploy"
            }
            steps{
                when{
                    changeRequest target: 'master'
                }
                sh "changeRequest target: master"
            }
        }
        stage('Gradlew Build'){
            steps{
                script{
                    sh """
                    chmod +x ./gradlew
                    ./gradlew build
                    """
                }
            }
        }
        stage('Test'){
            steps{
                script{
                    sh "./gradlew test"
                    sh "./gradlew check"
                    sh "echo 'generating coverage report'"
                    sh "./gradlew codeCoverageReport"
                    sh "echo 'send it to codecov'"
                    sh "curl -s https://codecov.io/bash | bash"
                }
            }
        }
        stage('Push image to Harbor'){
            when{
                allOf {
                    branch 'master';
                    environment CHANGE_ID: null
                }
            }
            steps{
                sh """
                ./gradlew jib -PHARBOR_USERNAME="${HARBOR_USERNAME}" -PHARBOR_PASSWORD="${HARBOR_PASSWORD}" -PDOCKER_IMG_BASE_REPOSITORY="${DOCKER_IMG_BASE_REPOSITORY}" -PHARBOR_REPOSITORY="${HARBOR_REPOSITORY}" -PIMG_TAG="${env.GIT_COMMIT}"
                """
            }
        }
    }
}
